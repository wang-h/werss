# ==================== 本地开发配置 ====================
# 使用方式: docker-compose -f docker-compose.dev.yml up -d
# 
# 特点：
# - 所有服务直接暴露端口，方便本地访问
# - 不需要 Traefik 和域名配置
# - MinIO 使用 HTTP 访问
# - 简化配置，快速启动

services:
  # ==================== PostgreSQL 数据库 ====================
  postgres:
    image: postgres:16-alpine
    container_name: postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      TZ: Asia/Shanghai
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "work_mem=4MB"
    ports:
      - "5432:5432"  # 直接暴露，方便本地连接
    volumes:
      - ./data/postgres-data-dev:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - werss_network


  # ==================== MinIO 对象存储 ====================
  minio:
    image: minio/minio:latest
    container_name: minio-dev
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
      - MINIO_SERVER_URL=http://localhost:9000
    ports:
      - "9000:9000"  # API 端口
      - "9001:9001"  # Console 端口
    volumes:
      - ./data/minio-data-dev:/data
    networks:
      - werss_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==================== WeRSS 服务 ====================
  werss:
    build:
      context: .
      dockerfile: Dockerfile.cn
    container_name: werss-dev
    restart: unless-stopped
    env_file:
      - .env.dev  # 从 .env.dev 文件加载环境变量
    ports:
      - "8001:8001"  # 直接暴露，方便本地访问
    environment:
      # 数据库连接
      - DB=postgresql://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_WERSS_DB}
      
      # 用户认证
      - USERNAME=${WERSS_USERNAME}
      - PASSWORD=${WERSS_PASSWORD}
      
      # 服务器配置
      - SERVER_NAME=${SERVER_NAME:-werss}
      - WEB_NAME=${WEB_NAME:-WeRSS微信热度分析系统}
      - SEND_CODE=${SEND_CODE:-True}
      - CODE_TITLE=${CODE_TITLE:-WeRSS}
      - ENABLE_JOB=${ENABLE_JOB:-True}
      - AUTO_RELOAD=${AUTO_RELOAD:-False}
      - THREADS=${THREADS:-2}
      - WERSS_AUTH_WEB=${WERSS_AUTH_WEB:-False}
      
      # 应用配置
      - APP_NAME=${APP_NAME:-werss}
      - SECRET_KEY=${SECRET_KEY:-werss}
      - USER_AGENT=${USER_AGENT:-Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36/WeRss}
      - PORT=${PORT:-8001}
      - DEBUG=${DEBUG:-True}  # 开发环境默认开启调试模式
      
      # 定时任务配置
      - SPAN_INTERVAL=${SPAN_INTERVAL:-10}
      - MAX_PAGE=${MAX_PAGE:-5}
      
      # 采集配置（环境变量名使用下划线，代码会自动处理点号到下划线的转换）
      - GATHER_CONTENT=${GATHER_CONTENT:-True}
      - GATHER_MODEL=${GATHER_MODEL:-app}
      - GATHER_CONTENT_AUTO_CHECK=${GATHER_CONTENT_AUTO_CHECK:-True}
      - GATHER_CONTENT_AUTO_INTERVAL=${GATHER_CONTENT_AUTO_INTERVAL:-59}
      - GATHER_CONTENT_MODE=${GATHER_CONTENT_MODE:-web}
      - GATHER_CLEAN_HTML=${GATHER_CLEAN_HTML:-True}
      - BROWSER_TYPE=${BROWSER_TYPE:-firefox}
      - INSTALL=${INSTALL:-True}  # Docker 环境默认安装 Playwright 浏览器
      # Playwright 下载镜像源配置（加速下载）
      - PLAYWRIGHT_DOWNLOAD_HOST=https://npmmirror.com/mirrors/playwright/
      - PLAYWRIGHT_DOWNLOAD_CONNECTION_TIMEOUT=300000
      
      # RSS 配置（开发环境使用 localhost）
      - RSS_BASE_URL=http://localhost:8001
      - RSS_LOCAL=${RSS_LOCAL:-False}
      - RSS_TITLE=${RSS_TITLE:-}
      - RSS_DESCRIPTION=${RSS_DESCRIPTION:-}
      - RSS_COVER=${RSS_COVER:-}
      - RSS_FULL_CONTEXT=${RSS_FULL_CONTEXT:-True}
      - RSS_ADD_COVER=${RSS_ADD_COVER:-True}
      - RSS_CDATA=${RSS_CDATA:-False}
      - RSS_PAGE_SIZE=${RSS_PAGE_SIZE:-30}
      
      # 通知配置（可选，开发环境可以不配置）
      - DINGDING_WEBHOOK=${DINGDING_WEBHOOK:-}
      - FEISHU_WEBHOOK=${FEISHU_WEBHOOK:-}
      - WECHAT_WEBHOOK=${WECHAT_WEBHOOK:-}
      - CUSTOM_WEBHOOK=${CUSTOM_WEBHOOK:-}
      
      # Webhook 配置
      - WEBHOOK_CONTENT_FORMAT=${WEBHOOK_CONTENT_FORMAT:-html}
      
      # 其他配置
      - TOKEN_EXPIRE_MINUTES=${TOKEN_EXPIRE_MINUTES:-4320}
      - CACHE_DIR=${CACHE_DIR:-data/cache}  # 注意：使用相对路径，相对于 /app，实际路径为 /app/data/cache
      - ARTICLE_TRUE_DELETE=${ARTICLE_TRUE_DELETE:-False}
      - LOG_LEVEL=${LOG_LEVEL:-DEBUG}  # 开发环境使用 DEBUG 级别日志
      - LOG_FILE=${LOG_FILE:-}
      - SAFE_HIDE_CONFIG=${SAFE_HIDE_CONFIG:-db,secret,token,notice.wechat,notice.feishu,notice.dingding}
      - SAFE_LIC_KEY=${SAFE_LIC_KEY:-werss}
      - EXPORT_PDF=${EXPORT_PDF:-False}
      - EXPORT_PDF_DIR=${EXPORT_PDF_DIR:-data/pdf}
      - EXPORT_MARKDOWN=${EXPORT_MARKDOWN:-False}
      - EXPORT_MARKDOWN_DIR=${EXPORT_MARKDOWN_DIR:-data/markdown}
      
      # 文章标签配置
      - ARTICLE_TAG_AUTO_EXTRACT=${ARTICLE_TAG_AUTO_EXTRACT:-True}
      - ARTICLE_TAG_EXTRACT_METHOD=${ARTICLE_TAG_EXTRACT_METHOD:-ai}
      - ARTICLE_TAG_MAX_TAGS=${ARTICLE_TAG_MAX_TAGS:-5}
      - ARTICLE_TAG_TEXTRANK_ALLOW_POS=${ARTICLE_TAG_TEXTRANK_ALLOW_POS:-n,nz,vn,a}
      - ARTICLE_TAG_KEYBERT_MODEL=${ARTICLE_TAG_KEYBERT_MODEL:-minishlab/potion-multilingual-128M}
      - ARTICLE_TAG_AI_AUTO_CREATE=${ARTICLE_TAG_AI_AUTO_CREATE:-True}
      
      # OPENAI API 配置（用于 AI 标签提取）
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_BASE_URL=${OPENAI_BASE_URL:-https://api.openai.com}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - OPENAI_RPM_LIMIT=${OPENAI_RPM_LIMIT:-60}
      - OPENAI_TIMEOUT=${OPENAI_TIMEOUT:-60}
      
      # MinIO 对象存储配置（用于图片上传）
      - MINIO_ENABLED=${MINIO_ENABLED:-True}
      - MINIO_ENDPOINT=minio:9000  # Docker 内部使用服务名（固定值，不依赖环境变量）
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-${MINIO_ROOT_USER:-admin}}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-${MINIO_ROOT_PASSWORD}}
      - MINIO_BUCKET=${MINIO_BUCKET:-werss-images}
      - MINIO_SECURE=False  # Docker 内部使用 HTTP（固定值）
      - MINIO_PUBLIC_URL=${MINIO_PUBLIC_URL:-http://localhost:9000}  # 开发环境使用 HTTP
      - MINIO_USE_PRESIGNED_URL=${MINIO_USE_PRESIGNED_URL:-False}
      
    volumes:
      - ./data/werss-data:/app/data  # 挂载数据目录，包含 cache、pdf、markdown 等子目录
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - werss_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8001/api/v1/sys/version || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
 
# volumes 已改为直接挂载到 ./data 目录，不再使用命名卷
# 注意：开发环境使用 -dev 后缀的数据目录，避免与生产环境冲突

networks:
  werss_network:
    driver: bridge
    name: werss_network
    ipam:
      config:
        - subnet: 172.28.0.0/16

