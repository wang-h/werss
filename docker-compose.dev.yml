# ==================== 本地开发配置 ====================
# 使用方式: docker-compose -f docker-compose.dev.yml up -d
# 
# 特点：
# - 所有服务直接暴露端口，方便本地访问
# - 不需要 Traefik 和域名配置
# - MinIO 使用 HTTP 访问
# - 简化配置，快速启动

services:
  # ==================== PostgreSQL 数据库 ====================
  postgres:
    image: postgres:16-alpine
    container_name: postgres-dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"
      TZ: Asia/Shanghai
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "work_mem=4MB"
    ports:
      - "5432:5432"  # 直接暴露，方便本地连接
    volumes:
      - ./data/postgres-data-dev:/var/lib/postgresql/data
      - ./init-db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - werss_network


  # ==================== MinIO 对象存储 ====================
  minio:
    image: minio/minio:latest
    container_name: minio-dev
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
      - MINIO_SERVER_URL=http://localhost:9000
    ports:
      - "9000:9000"  # API 端口
      - "9001:9001"  # Console 端口
    volumes:
      - ./data/minio-data-dev:/data
    networks:
      - werss_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
 
 
# volumes 已改为直接挂载到 ./data 目录，不再使用命名卷
# 注意：开发环境使用 -dev 后缀的数据目录，避免与生产环境冲突

networks:
  werss_network:
    driver: bridge
    name: werss_network
    # 移除固定子网配置，让 Docker 自动分配以避免与其他网络冲突
    # 如果需要固定子网，可以取消下面的注释并修改为不冲突的子网
    # ipam:
    #   config:
    #     - subnet: 172.29.0.0/16

